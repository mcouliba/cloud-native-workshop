apiVersion: 1.0.0
metadata:
  name: wksp-cloud-native
projects:
  - name: workshop
    source:
      location: 'https://github.com/mcouliba/cloud-native-workshop.git'
      type: git
      branch: "3.2"
components:
  - type: dockerimage
    alias: maven
    image: 'quay.io/eclipse/che-java11-maven:7.4.0'
    memoryLimit: 256Mi
    mountSources: true
    endpoints:
      - name: localhost-8080
        port: 8080
      - name: localhost-9000
        port: 9000
  - id: redhat/workshop-tools/3.1
    type: chePlugin
    alias: workshop-tools
commands:
  - name: 'Inventory - Compile (Dev Mode)'
    actions:
      - workdir: /projects/workshop/labs/inventory-quarkus
        type: exec
        command: 'mvn compile quarkus:dev'
        component: workshop-tools
  - name: 'Inventory - Build'
    actions:
      - workdir: /projects/workshop/labs/inventory-quarkus
        type: exec
        command: mvn clean package -DskipTests
        component: workshop-tools
  - name: 'Catalog - Build'
    actions:
      - workdir: /projects/workshop/labs/catalog-spring-boot
        type: exec
        command: mvn clean package -DskipTests
        component: workshop-tools
  - name: 'Catalog - Run'
    actions:
      - workdir: /projects/workshop/labs/catalog-spring-boot
        type: exec
        command: mvn spring-boot:run
        component: workshop-tools
  - name: 'Gateway - Build'
    actions:
      - workdir: /projects/workshop/labs/gateway-vertx
        type: exec
        command: 'mvn clean package -DskipTests'
        component: workshop-tools
  - name: 'GitOps - Export'
    actions:
      - workdir: /projects/workshop/labs/gitops
        type: exec
        command: ./gitops_exporter.sh my-project${CHE_WORKSPACE_NAMESPACE#user} staging-project${CHE_WORKSPACE_NAMESPACE#user}
        component: workshop-tools
  - name: 'Gateway - Generate Traffic'
    actions:
      - workdir: /projects/workshop/labs/scripts
        type: exec
        command: ./runGatewayService.sh staging-project${CHE_WORKSPACE_NAMESPACE#user}
        component: workshop-tools
  - name: 'Pipeline - Start Mine'
    actions:
      - type: exec
        command: >-
          echo "------ START ------" &&
          tkn pipeline start my-pipeline --resource component-git=inventory-git --param componentName=inventory-coolstore --serviceaccount pipeline --namespace staging-project${CHE_WORKSPACE_NAMESPACE#user} &&
          echo "------  END  ------"
        component: workshop-tools
        workdir: /projects/workshop/labs/pipelines
  - name: 'Pipeline - Start Inventory'
    actions:
      - type: exec
        command: >-
          echo "------ START ------";
          oc new-build java --name=inventory-coolstore --binary=true --labels=app=coolstore,app.kubernetes.io/instance=inventory --namespace=staging-project${CHE_WORKSPACE_NAMESPACE#user} 2> /dev/null;
          oc apply -f .;
          tkn pipeline start jar-pipeline --resource component-git=inventory-git --param componentName=inventory-coolstore --serviceaccount pipeline --namespace staging-project${CHE_WORKSPACE_NAMESPACE#user};
          echo "------  END  ------"
        component: workshop-tools
        workdir: /projects/workshop/labs/pipelines/inventory
  - name: 'Pipeline - Start All'
    actions:
      - type: exec
        command: >-
          ./deploy_coolstore_by_tekton.sh staging-project${CHE_WORKSPACE_NAMESPACE#user}
        component: workshop-tools
        workdir: /projects/workshop/labs/pipelines/others
  - name: 'Service Mesh - Deploy Catalog and Gateway'
    actions:
      - type: exec
        command: >-
          oc patch dc/catalog-coolstore --patch '{"spec": {"template": {"metadata": {"annotations": {"sidecar.istio.io/inject": "true"}}}}}' -n staging-project${CHE_WORKSPACE_NAMESPACE#user}&&
          oc patch dc/catalog-coolstore --patch '{"spec": {"template": {"spec": {"containers": [{"name": "catalog-coolstore", "command" : ["/bin/bash"], "args": ["-c", "until $(curl -o /dev/null -s -I -f http://127.0.0.1:15000); do echo \"Waiting for Istio Sidecar...\"; sleep 1; done; sleep 10; /usr/local/s2i/run"]}]}}}}' -n staging-project${CHE_WORKSPACE_NAMESPACE#user} &&
          oc rollout latest dc/catalog-coolstore -n staging-project${CHE_WORKSPACE_NAMESPACE#user} &&
          oc patch dc/gateway-coolstore --patch '{"spec": {"template": {"metadata": {"annotations": {"sidecar.istio.io/inject": "true"}}}}}' -n staging-project${CHE_WORKSPACE_NAMESPACE#user} &&
          oc patch dc/gateway-coolstore --patch '{"spec": {"template": {"spec": {"containers": [{"name": "gateway-coolstore", "command" : ["/bin/bash"], "args": ["-c", "until $(curl -o /dev/null -s -I -f http://127.0.0.1:15000); do echo \"Waiting for Istio Sidecar...\"; sleep 1; done; sleep 10; /usr/local/s2i/run"]}]}}}}' -n staging-project${CHE_WORKSPACE_NAMESPACE#user} &&
          oc rollout latest dc/gateway-coolstore -n staging-project${CHE_WORKSPACE_NAMESPACE#user}
        component: workshop-tools
  - name: 'OpenShift - Cleanup'
    actions:
      - type: exec
        command: >-
          echo "------ START ------";
          git checkout .;
          git clean -fd;
          git clean -f;
          oc delete project my-project${CHE_WORKSPACE_NAMESPACE#user};
          oc delete deployment,deploymentconfig,buildconfig,imagestream,route,secret,configmap,service --all --namespace staging-project${CHE_WORKSPACE_NAMESPACE#user};
          echo "------  END  ------"
        component: workshop-tools
        workdir: /projects/workshop
  - name: 'Inventory - Code'
    actions:
      - type: exec
        command: >-
          echo "------ START ------";
          ./solve.sh;
          echo "------  END  ------"
        component: workshop-tools
        workdir: /projects/workshop/labs/solutions/inventory-quarkus
  - name: 'Catalog & Gateway - Code & Deploy'
    actions:
      - type: exec
        command: >-
          echo "------ START ------";
          cd catalog-spring-boot;./solve_deploy.sh;cd ..;
          cd gateway-vertx;./solve_deploy.sh;cd ..;
          echo "------  END  ------"
        component: workshop-tools
        workdir: /projects/workshop/labs/solutions
  - name: 'Catalog - Externalize Configuration'
    actions:
      - type: exec
        command: >-
          echo "------ START ------";
          cat <<EOF > /projects/catalog-openshift-application.properties
          spring.datasource.url=jdbc:postgresql://catalog-postgresql.my-project${CHE_WORKSPACE_NAMESPACE#user}.svc:5432/catalogdb
          spring.datasource.username=catalog
          spring.datasource.password=catalog
          spring.datasource.driver-class-name=org.postgresql.Driver
          spring.jpa.hibernate.ddl-auto=create
          spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation=true
          EOF;
          oc create configmap catalog --from-file=application.properties=/projects/catalog-openshift-application.properties -n my-project${CHE_WORKSPACE_NAMESPACE#user};
          oc label configmap catalog app=coolstore app.kubernetes.io/instance=catalog -n my-project${CHE_WORKSPACE_NAMESPACE#user};
          echo "------  END  ------"
        component: workshop-tools
        workdir: /projects/workshop/
  - name: 'Probes & Config - Deploy'
    actions:
      - type: exec
        command: >-
          echo "------ START ------";
          cd health-probes; ./deploy.sh; cd ..;
          cd app-config; ./deploy.sh; cd ..;
          echo "------  END  ------"
        component: workshop-tools
        workdir: /projects/workshop/labs/solutions